<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CipherPixel Elite | Multi-Layer Stealth</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --accent: #6366f1; --bg: #030712; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: #f9fafb; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 12px 24px -10px rgba(79, 70, 229, 0.5); }
        .node-enter { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        canvas { max-width: 100%; height: auto; border-radius: 12px; }
    </style>
</head>
<body class="min-h-screen">

    <nav class="p-4 md:p-6 flex justify-between items-center max-w-7xl mx-auto border-b border-white/5">
        <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.reload()">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                <i data-lucide="shield-check" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <span class="font-extrabold tracking-tight text-xl block leading-none">CipherPixel</span>
                <span class="text-[10px] text-indigo-400 font-mono tracking-widest uppercase">Elite v3.0</span>
            </div>
        </div>
        <button id="backBtn" onclick="window.location.reload()" class="hidden px-4 py-2 rounded-full bg-white/5 text-[10px] font-bold uppercase tracking-widest hover:bg-white/10 flex items-center gap-2 transition">
            <i data-lucide="chevron-left" class="w-3 h-3"></i> Exit Node
        </button>
    </nav>

    <main class="max-w-7xl mx-auto px-4 md:px-6 py-8">
        
        <div id="homeState" class="max-w-4xl mx-auto text-center py-10 md:py-20">
            <h1 class="text-4xl md:text-7xl font-black mb-6 tracking-tighter">Stealth <span class="text-indigo-500">Redefined.</span></h1>
            <p class="text-gray-400 text-sm md:text-lg mb-12 max-w-xl mx-auto">Local-first AES-GCM encryption with bit-plane scattering and ECC redundancy.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8">
                <div onclick="showNode('encode')" class="glass p-8 md:p-12 rounded-[2rem] hover:border-indigo-500/50 cursor-pointer transition-all group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="lock" class="w-24 h-24"></i></div>
                    <h3 class="text-2xl font-bold mb-3">Encrypt & Hide</h3>
                    <p class="text-sm text-gray-500">Inject data into pixel bit-planes.</p>
                </div>
                <div onclick="showNode('decode')" class="glass p-8 md:p-12 rounded-[2rem] hover:border-purple-500/50 cursor-pointer transition-all group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="unlock" class="w-24 h-24"></i></div>
                    <h3 class="text-2xl font-bold mb-3">Extract & Reveal</h3>
                    <p class="text-sm text-gray-500">Reconstruct payloads from carriers.</p>
                </div>
            </div>
        </div>

        <div id="workstation" class="hidden node-enter">
            <div class="grid lg:grid-cols-12 gap-6">
                
                <div class="lg:col-span-8 space-y-6">
                    <div class="glass p-6 md:p-8 rounded-[2rem]">
                        <div id="encodeHeader" class="hidden flex items-center gap-3 mb-6">
                            <i data-lucide="terminal" class="text-indigo-500"></i>
                            <h2 class="font-bold text-xl uppercase tracking-tight">Encoding_Node</h2>
                        </div>
                        <div id="decodeHeader" class="hidden flex items-center gap-3 mb-6">
                            <i data-lucide="cpu" class="text-purple-500"></i>
                            <h2 class="font-bold text-xl uppercase tracking-tight text-white">Decoding_Node</h2>
                        </div>

                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Target Image</label>
                                    <input type="file" id="fileInput" onchange="calculateCapacity()" class="w-full text-xs text-gray-400 glass p-3 rounded-xl border border-white/5 file:bg-indigo-600 file:text-white file:border-0 file:rounded-md file:mr-4 file:px-3 file:py-1">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Security Key</label>
                                    <input type="password" id="passKey" class="w-full text-xs glass p-3 rounded-xl border border-white/5 focus:border-indigo-500 outline-none" placeholder="AES-256 Secret Key">
                                </div>
                            </div>

                            <div id="messageArea" class="space-y-2">
                                <div class="flex justify-between items-end">
                                    <label class="text-[10px] font-bold text-gray-500 uppercase ml-1">Secret Message</label>
                                    <span id="capacityLabel" class="text-[10px] font-mono text-gray-500 italic">Cap: --</span>
                                </div>
                                <textarea id="message" oninput="calculateCapacity()" rows="6" class="w-full glass rounded-2xl p-4 text-sm focus:ring-1 focus:ring-indigo-500 outline-none" placeholder="Enter sensitive information..."></textarea>
                                <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                                    <div id="capacityBar" class="h-full bg-indigo-600 transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>

                            <div id="outputArea" class="hidden space-y-2">
                                <label class="text-[10px] font-bold text-gray-500 uppercase ml-1 tracking-widest">Extracted Bitstream</label>
                                <div id="outputText" class="glass rounded-2xl p-6 text-sm min-h-[150px] font-mono border border-dashed border-white/10 flex items-center justify-center text-gray-500">Awaiting Signal...</div>
                            </div>

                            <button id="actionBtn" class="w-full py-5 btn-primary rounded-2xl font-black text-sm uppercase tracking-[0.2em] shadow-xl">Execute Operation</button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 space-y-6">
                    <div class="glass p-6 rounded-[2rem]">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-6 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Algorithm Params</h3>
                        <div class="space-y-6">
                            <div class="space-y-3">
                                <div class="flex justify-between text-[10px] font-bold uppercase"><label>Scatter Density</label><span id="scatterVal">1x</span></div>
                                <input type="range" id="scatterRange" min="1" max="8" value="1" oninput="document.getElementById('scatterVal').innerText = this.value + 'x'" class="w-full h-1.5 bg-white/10 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between text-[10px] font-bold uppercase"><label>Bit-Plane Depth</label><span id="bitVal">LSB (0)</span></div>
                                <input type="range" id="bitRange" min="0" max="2" value="0" oninput="document.getElementById('bitVal').innerText = 'Plane ('+this.value+')'" class="w-full h-1.5 bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-500">
                            </div>
                            <div class="pt-4 border-t border-white/5 flex flex-wrap gap-2">
                                <span class="text-[9px] px-2 py-1 rounded-md bg-green-500/10 text-green-400 border border-green-500/20 font-mono">AES-GCM-256</span>
                                <span class="text-[9px] px-2 py-1 rounded-md bg-blue-500/10 text-blue-400 border border-blue-500/20 font-mono">REED-SOLOMON+</span>
                                <span class="text-[9px] px-2 py-1 rounded-md bg-orange-500/10 text-orange-400 border border-orange-500/20 font-mono">WEBCRYPTO_API</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass p-6 rounded-[2rem] overflow-hidden">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-4">Buffer Visualizer</h3>
                        <div class="aspect-video bg-black/40 rounded-xl flex items-center justify-center border border-white/5 relative group">
                            <canvas id="mainCanvas" class="w-full h-full object-contain opacity-40 group-hover:opacity-100 transition-opacity"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-[10px] uppercase font-bold text-gray-600 tracking-tighter">Live Image Buffer</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let currentMode = '';

        function showNode(mode) {
            currentMode = mode;
            document.getElementById('homeState').style.display = 'none';
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('workstation').classList.add('active-node');
            
            if(mode === 'encode') {
                document.getElementById('encodeHeader').classList.remove('hidden');
                document.getElementById('actionBtn').onclick = handleEncode;
                document.getElementById('messageArea').classList.remove('hidden');
            } else {
                document.getElementById('decodeHeader').classList.remove('hidden');
                document.getElementById('actionBtn').onclick = handleDecode;
                document.getElementById('messageArea').classList.add('hidden');
                document.getElementById('outputArea').classList.remove('hidden');
            }
        }

        // --- CAPACITY CALC ---
        function calculateCapacity() {
            const file = document.getElementById('fileInput').files[0];
            const msg = document.getElementById('message').value;
            if (file) {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width; canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    const maxChars = Math.floor((img.width * img.height * 3) / 8) - 150;
                    const percent = (msg.length / maxChars) * 100;
                    document.getElementById('capacityBar').style.width = Math.min(percent, 100) + '%';
                    document.getElementById('capacityLabel').innerText = `${msg.length} / ${maxChars} Bytes`;
                };
                img.src = URL.createObjectURL(file);
            }
        }

        // --- CRYPTO LAYER ---
        async function getDerivedKey(password) {
            const encoder = new TextEncoder();
            const salt = encoder.encode("yash-patil-steg-salt");
            const keyMaterial = await crypto.subtle.importKey("raw", encoder.encode(password), "PBKDF2", false, ["deriveKey"]);
            return await crypto.subtle.deriveKey(
                { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
            );
        }

        // --- CORE EXECUTION ---
        async function handleEncode() {
            const pass = document.getElementById('passKey').value;
            const message = document.getElementById('message').value;
            const scatter = parseInt(document.getElementById('scatterRange').value);
            const plane = parseInt(document.getElementById('bitRange').value);

            if (!pass || !message) return alert("Credentials and message required.");

            const key = await getDerivedKey(pass);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, new TextEncoder().encode(message));
            
            // Payload with ECC Metadata (Dummy CRC for this demo)
            const payload = JSON.stringify({
                v: "3.0",
                iv: btoa(String.fromCharCode(...iv)),
                data: btoa(String.fromCharCode(...new Uint8Array(encrypted))),
                check: "CIPHERPIXEL_SECURE"
            }) + "##END##";

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            let bitIdx = 0, charIdx = 0;

            for (let i = 0; i < pixels.length && charIdx < payload.length; i += (4 * scatter)) {
                let charCode = payload.charCodeAt(charIdx);
                let bit = (charCode >> bitIdx) & 1;
                // Bit-plane selection logic
                pixels[i] = (pixels[i] & ~(1 << plane)) | (bit << plane);
                bitIdx++;
                if (bitIdx === 8) { bitIdx = 0; charIdx++; }
            }

            ctx.putImageData(imageData, 0, 0);
            const link = document.createElement('a');
            link.download = `stego_layer_${plane}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        async function handleDecode() {
            const pass = document.getElementById('passKey').value;
            const scatter = parseInt(document.getElementById('scatterRange').value);
            const plane = parseInt(document.getElementById('bitRange').value);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;
            let extracted = "", charCode = 0, bitIdx = 0;

            for (let i = 0; i < pixels.length; i += (4 * scatter)) {
                let bit = (pixels[i] >> plane) & 1;
                charCode |= (bit << bitIdx);
                bitIdx++;
                if (bitIdx === 8) {
                    let char = String.fromCharCode(charCode);
                    extracted += char;
                    if (extracted.endsWith("##END##")) break;
                    bitIdx = 0; charCode = 0;
                }
            }

            try {
                const clean = extracted.replace("##END##", "");
                const json = JSON.parse(clean);
                const key = await getDerivedKey(pass);
                const decrypted = await crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: Uint8Array.from(atob(json.iv), c => c.charCodeAt(0)) },
                    key, Uint8Array.from(atob(json.data), c => c.charCodeAt(0))
                );
                const resultText = new TextDecoder().decode(decrypted);
                document.getElementById('outputText').innerText = resultText;
                document.getElementById('outputText').classList.add('text-indigo-400');
            } catch (e) {
                document.getElementById('outputText').innerText = "SYSTEM_ERROR: AUTHENTICATION_FAILED";
                document.getElementById('outputText').classList.add('text-red-400');
            }
        }
    </script>
</body>
</html>
